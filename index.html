<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Raport Kredytowy</title>
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#0b1220">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon-192.png" sizes="192x192" type="image/png">

  <style>
    /* LIGHT (domy≈õlnie) */
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --accent:#2563eb;
      --good:#16a34a; --bad:#dc2626; --muted:#6b7280; --grid:#e5e7eb;
      --pill-track:#e5e7eb; --pill-border:#d1d5db;
    }
    /* DARK */
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#121416; --card:#1f2937; --text:#e2e6e9; --accent:#52b0ff;
        --good:#40c09e; --bad:#e65050; --muted:#9ca3af; --grid:#2a3342;
        --pill-track:#2b2b2b; --pill-border:#313131;
      }
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:0}
    main, header{max-width:640px;margin:0 auto}
    .card{background:var(--card);border-radius:16px;margin:16px;padding:0;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .pad{padding:18px}

    header .title{font-size:24px;font-weight:800;text-align:center;color:var(--accent)}
    #asOf{text-align:center;margin-top:6px;font-size:13px;color:var(--muted)}

    /* KPI */
    .kpis{display:grid;grid-template-columns:1fr;gap:12px}
    .kpi{background:color-mix(in oklab, var(--card) 80%, black 8%);border-radius:12px;padding:14px;text-align:center;border:1px solid color-mix(in oklab, var(--card), black 14%)}
    .kpi .label{font-size:13px;color:var(--muted);letter-spacing:.02em}
    .kpi .val{font-size:24px;font-weight:800;margin-top:6px}
    .nowrap{white-space:nowrap}
    .value.up{color:var(--bad)} .value.down{color:var(--good)}

    /* akordeon (bez animacji ‚Äì stabilnie) */
    .acc-head{
      position:relative;width:100%;background:transparent;border:0;padding:16px 44px;
      display:flex;align-items:center;justify-content:center;gap:10px;
      color:var(--accent);font-weight:900;font-size:22px;cursor:pointer
    }
    .acc-dot{position:absolute;left:16px;top:calc(50% - 6px);width:12px;height:12px;border-radius:50%;
      background:color-mix(in oklab, var(--card), black 35%);transition:background .2s,box-shadow .25s}
    .acc-head[aria-expanded="true"] .acc-dot{background:var(--good);box-shadow:0 0 10px color-mix(in oklab, var(--good), transparent 60%)}
    .acc-chev{position:absolute;right:16px;top:50%;transform:translateY(-50%) rotate(-45deg);
      width:10px;height:10px;border-right:2px solid var(--accent);border-bottom:2px solid var(--accent);transition:transform .2s}
    .acc-head[aria-expanded="true"] .acc-chev{transform:translateY(-50%) rotate(45deg)}
    .acc-body{display:none}
    .acc-body.open{display:block}

    /* Postƒôp sp≈Çaty ‚Äì kafelek */
    .progress-card{padding-top:6px}
    .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0 14px}
    @media (max-width:360px){ .stat-grid{grid-template-columns:1fr} }
    .stat{background:color-mix(in oklab, var(--card) 85%, black 10%);border:1px solid color-mix(in oklab, var(--card), black 18%);border-radius:14px;padding:12px 14px}
    .stat .stat-label{font-size:12px;letter-spacing:.02em;color:var(--muted)}
    .stat .stat-value{margin-top:4px;font-size:18px;font-weight:800;color:var(--text);white-space:nowrap}

    .pill{position:relative;height:28px;background:var(--pill-track);border-radius:999px;overflow:hidden;border:1px solid var(--pill-border)}
    .pill .fill{height:100%;width:0%;background:linear-gradient(90deg,#1D4ED8,#60A5FA);border-radius:inherit;transition:width 900ms ease}
    .pill .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-weight:800;color:#fff;pointer-events:none;user-select:none;text-shadow:0 1px 1px rgba(0,0,0,.35)}
    .progress-foot{margin-top:8px;font-size:13px;color:var(--muted);text-align:center}

    /* wykresy */
    .chart-box{display:flex;justify-content:center}
    canvas.chart-sm{width:320px;height:180px!important;max-width:100%}

    /* tabele */
    table.tbl{width:100%;border-collapse:collapse;border:1px solid color-mix(in oklab, var(--card), black 22%);border-radius:12px;overflow:hidden}
    .tbl th,.tbl td{padding:12px 14px;border:1px solid color-mix(in oklab, var(--card), black 22%);font-size:14px;text-align:center;vertical-align:middle;white-space:nowrap}
    .tbl th{background:color-mix(in oklab, var(--card), black 30%);color:var(--text);font-weight:700}

    #errorBox{color:#ff6b6b;background:#2d1b1b;padding:14px;text-align:center;display:none;margin:16px;border-radius:8px;border:1px solid #ff6b6b}
  </style>

  <script>
    // Podbijaj wersjƒô przy ka≈ºdym deployu
    window.APP_VERSION='v3.7.0';
    window.RAPORT_ENDPOINT='https://script.google.com/macros/s/AKfycbymwnWurFrti71e3PDkm658dfRswPE-OFjTGKs24TdxYi2aS2btOPTm2Hb5xsOLe4II9w/exec?path=/api/report/json';
  </script>

  <!-- Chart.js (pin) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>

  <!-- Rejestracja Service Workera (cache bust + auto-refresh) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('./sw.js?v='+encodeURIComponent(window.APP_VERSION));
          // auto refresh po aktualizacji SW
          reg.addEventListener('updatefound', () => {
            const nw = reg.installing;
            if (!nw) return;
            nw.addEventListener('statechange', () => {
              if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                reg.active?.postMessage?.('SKIP_WAITING');
                setTimeout(() => location.reload(), 300);
              }
            });
          });
          setTimeout(()=>reg.update().catch(()=>{}), 2000);
        } catch(e){ /* cicho */ }
      });
    }
  </script>
</head>
<body>
  <header class="card">
    <div class="pad">
      <div class="title">üìä Raport Kredytowy</div>
      <div id="asOf">≈Åadowanie‚Ä¶</div>
    </div>
  </header>

  <main>
    <!-- KPI -->
    <section class="card">
      <div class="pad">
        <div class="kpis">
          <div class="kpi"><div class="label">WIBOR 3M</div><div id="wibor" class="val">‚Äì</div></div>
          <div class="kpi"><div class="label">Obecna rata</div><div id="curr" class="val">‚Äì</div></div>
          <div class="kpi"><div class="label">Szacowana rata</div><div id="new" class="val">‚Äì</div></div>
          <div class="kpi"><div class="label">R√≥≈ºnica</div><div id="diff" class="val nowrap">‚Äì</div></div>
          <div class="kpi"><div class="label">Pozosta≈Ço rat</div><div id="raty" class="val">‚Äì</div><small id="ratySub"></small></div>
        </div>
      </div>
    </section>

    <!-- Postƒôp sp≈Çaty -->
    <section class="card">
      <button class="acc-head" data-target="acc-progress" aria-expanded="true">
        <span class="acc-dot"></span> Postƒôp sp≈Çaty <span class="acc-chev"></span>
      </button>
      <div id="acc-progress" class="acc-body open progress-card">
        <div class="pad">
          <div class="stat-grid">
            <div class="stat"><div class="stat-label">Kapita≈Ç poczƒÖtkowy</div><div class="stat-value"><span id="init">‚Äì</span></div></div>
            <div class="stat"><div class="stat-label">Kapita≈Ç sp≈Çacony</div><div class="stat-value"><span id="paid">‚Äì</span></div></div>
            <div class="stat"><div class="stat-label">Pozosta≈Ço do sp≈Çaty</div><div class="stat-value"><span id="rem">‚Äì</span></div></div>
            <div class="stat"><div class="stat-label">Sp≈Çacono</div><div class="stat-value"><span id="pct">0%</span></div></div>
          </div>
          <div class="pill" aria-label="Sp≈Çacono procent kapita≈Çu">
            <div id="bar" class="fill"></div>
            <div id="barLabel" class="label">0%</div>
          </div>
          <div class="progress-foot">To odsetek sp≈Çaconego kapita≈Çu w ca≈Çym kredycie</div>
        </div>
      </div>
    </section>

    <!-- Struktura raty -->
    <section class="card">
      <button class="acc-head" data-target="acc-pie" aria-expanded="true">
        <span class="acc-dot"></span> Struktura najbli≈ºszej raty <span class="acc-chev"></span>
      </button>
      <div id="acc-pie" class="acc-body open">
        <div class="pad" style="text-align:center">
          <div class="chart-box"><canvas id="pieChart" class="chart-sm"></canvas></div>
          <div style="margin-top:10px">Odsetki: <span id="odsetki">‚Äì</span> &nbsp;|&nbsp; Kapita≈Ç: <span id="kapital">‚Äì</span></div>
        </div>
      </div>
    </section>

    <!-- Historia WIBOR -->
    <section class="card">
      <button class="acc-head" data-target="acc-wibor" aria-expanded="true">
        <span class="acc-dot"></span> Historia WIBOR 3M <span class="acc-chev"></span>
      </button>
      <div id="acc-wibor" class="acc-body open">
        <div class="pad">
          <div class="chart-box"><canvas id="wiborChart" class="chart-sm"></canvas></div>
          <div id="histTableWrap"></div>
        </div>
      </div>
    </section>

    <!-- Prognozy FRA -->
    <section class="card">
      <button class="acc-head" data-target="acc-fra" aria-expanded="true">
        <span class="acc-dot"></span> Prognozy FRA <span class="acc-chev"></span>
      </button>
      <div id="acc-fra" class="acc-body open">
        <div class="pad">
          <div class="chart-box"><canvas id="fraChart" class="chart-sm"></canvas></div>
          <div id="fraTableWrap"></div>
        </div>
      </div>
    </section>
  </main>

  <div id="errorBox"></div>
  <script src="./app.js?v=v3.7.0" defer></script>
</body>
</html>
